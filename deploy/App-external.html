<!DOCTYPE html>
<html>
<head>
    <title>mvp-backlog-burndown</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc3/lib/analytics/analytics-all.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Rally.SolutionsArchitect.TimeSeriesCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",config:{group_by_field:null,value_field:null,allowed_values:null,allowed_oids:null,granularity:"day",value_type:"sum",endDate:null,startDate:null,workDays:"Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday".split(),useMVP:!1,mvpField:"",mvpValue:"",lastState:null},constructor:function(config){this.callParent(arguments),this._prepareDates()},_prepareDates:function(){if(""===this.startDate&&(this.startDate=null),""===this.endDate&&(this.endDate=null),this.startDate&&"object"==typeof this.startDate&&(this.startDate=Rally.util.DateTime.toIsoString(this.startDate)),this.endDate&&"object"==typeof this.endDate&&(this.endDate=Rally.util.DateTime.toIsoString(this.endDate)),this.startDate&&!/-/.test(this.startDate))throw"Failed to create Rally.TechnicalServices.CFDCalculator: startDate must be a javascript date or ISO date string";if(this.endDate&&!/-/.test(this.endDate))throw"Failed to create Rally.TechnicalServices.CFDCalculator: endDate must be a javascript date or ISO date string";if(this.startDate&&this.endDate&&this.startDate>this.endDate){var holder=this.startDate;this.startDate=this.endDate,this.endDate=holder}this.startDate&&(this.startDate=this.startDate.replace(/T.*$/,"")),this.endDate&&(this.endDate=this.endDate.replace(/T.*$/,""))},getDerivedFieldsOnInput:function(){var that=this,accepted=function(state){return"Accepted"===state||state===that.lastState},isMVP=function(snapshot){return snapshot[that.mvpField]===that.mvpValue};return[{as:"MVP",f:function(snapshot){return that.useMVP===!0?isMVP(snapshot)?snapshot.PlanEstimate:0:0}},{as:"Non-MVP",f:function(snapshot){return that.useMVP===!0?isMVP(snapshot)?0:snapshot.PlanEstimate:0}},{as:"ToDo",f:function(snapshot){return accepted(snapshot.ScheduleState)?0:snapshot.PlanEstimate}},{as:"Completed",f:function(snapshot){return accepted(snapshot.ScheduleState)?-1*snapshot.PlanEstimate:0}}]},getMetrics:function(){return[{as:"ToDo",field:"ToDo",f:"sum",display:"column"},{as:"Completed",field:"Completed",f:"sum",display:"column"},{as:"MVP",field:"MVP",f:"sum",display:"column"},{as:"Non-MVP",field:"Non-MVP",f:"sum",display:"column"}]},runCalculation:function(snapshots){var calculatorConfig=this._prepareCalculatorConfig(),seriesConfig=this._buildSeriesConfig(calculatorConfig),calculator=this.prepareCalculator(calculatorConfig),clean_snapshots=this._convertNullToBlank(snapshots);null!==this.allowed_oids&&(clean_snapshots=this._getAllowedSnapshots(clean_snapshots)),clean_snapshots.length>0&&calculator.addSnapshots(clean_snapshots,this._getStartDate(clean_snapshots),this._getEndDate(clean_snapshots));var chart_data=this._transformLumenizeDataToHighchartsSeries(calculator,seriesConfig);return Ext.Array.each(chart_data.series,function(series){""===series.name&&(series.name="None"),series.name===!1&&(series.name="False"),series.name===!0&&(series.name="True")}),chart_data},_convertNullToBlank:function(snapshots){for(var number_of_snapshots=snapshots.length,i=0;number_of_snapshots>i;i++)null===snapshots[i][this.group_by_field]&&(snapshots[i][this.group_by_field]="");return snapshots}});
                Ext.define("Rally.SolutionArchitect.Chart",{extend:"Rally.ui.chart.Chart",alias:"widget.progresschart",itemId:"rally-chart",chartData:{},loadMask:!1,chartConfig:{chart:{type:"column"},title:{text:"Project Burndown"},xAxis:{title:{text:"Iteration"},labels:{rotation:-45,style:{fontSize:"10px",fontFamily:"Verdana, sans-serif"}}},yAxis:[{title:{text:"Points"}}],plotOptions:{column:{dataLabels:{enabled:!0,borderRadius:5,backgroundColor:"rgba(252, 255, 197, 0.7)",borderWidth:1,borderColor:"#AAA",formatter:function(){return 0!==this.y?0>this.y?-1*this.y:this.y:""}}},series:{stacking:"normal"}}},constructor:function(config){this.callParent(arguments),config.title&&(this.chartConfig.title=config.title)}});
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"display_box",margin:10}],maxMonths:6,launch:function(){var me=this;console.log("context",me.getContext().getProjectScopeDown()),app=this,me.useMVP=me.getSetting("usemvp")===!0||"true"===me.getSetting("usemvp"),me.mvpField=me.getSetting("mvpfield"),me.mvpValue=me.getSetting("mvpvalue"),me.maxMonths=parseInt(me.getSetting("maxMonths")),console.log(me.useMVP,me.mvpField,me.mvpValue),Deft.Chain.pipeline([me.getLastState,me.getIterations,me.getSnapshots],me).then({success:function(results){me.hideMask();var accepted=function(state){return"Accepted"===state||state===me.lastState},isMVP=function(snapshot){return snapshot.get(me.mvpField)===me.mvpValue},seriesData=_.map(results,function(result,i){var snapsByID=_.groupBy(result,function(snapshot){return snapshot.get("ObjectID")}),snapshots=_.map(_.keys(snapsByID),function(id){return _.last(_.sortBy(snapsByID[id],function(s){return moment(s.get("_ValidFrom"))}))}),completedPoints=_.reduce(snapshots,function(memo,snapshot){return memo+(accepted(snapshot.get("ScheduleState"))?snapshot.get("PlanEstimate"):0)},0),todoPoints=_.reduce(snapshots,function(memo,snapshot){return memo+(accepted(snapshot.get("ScheduleState"))?0:snapshot.get("PlanEstimate"))},0),mvpToDo=_.reduce(snapshots,function(memo,snapshot){return memo+(me.useMVP===!0&&!accepted(snapshot.get("ScheduleState"))&&isMVP(snapshot)?snapshot.get("PlanEstimate"):null)},0),nonMvpToDo=_.reduce(snapshots,function(memo,snapshot){return memo+(me.useMVP!==!0||accepted(snapshot.get("ScheduleState"))||isMVP(snapshot)?0:snapshot.get("PlanEstimate"))},0);return{iteration:me.iterations[i].raw.Name,endDate:me.iterations[i].raw.EndDate,Completed:-1*completedPoints,ToDo:todoPoints,MVP:mvpToDo,NonMVP:nonMvpToDo}}),series=_.map(me.useMVP!==!0?["ToDo","Completed"]:["MVP","NonMVP","Completed"],function(seriesName){return{name:seriesName,type:"column",data:_.map(seriesData,function(sd){return moment(sd.endDate)<=moment()?sd[seriesName]:null})}});console.log("seriesData",seriesData,series);var categories=_.map(me.iterations,function(i){return i.raw.Name});_.isUndefined(me.chart)||me.remove(that.chart),me.chart=Ext.create("Rally.SolutionArchitect.Chart",{itemId:"rally-chart",chartData:{series:series,categories:categories,chartColors:me.useMVP===!0?["#0000FF","#87CEEB","#008800"]:["#87CEEB","#008800"]},chartColors:me.useMVP===!0?["#0000FF","#87CEEB","#008800"]:["#87CEEB","#008800"]}),me.add(me.chart)},failure:function(error){me.hideMask(),console.log("error---",error)}})},getLastState:function(){var me=this,deferred=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:"UserStory",success:function(model){model.getField("ScheduleState").getAllowedValueStore().load({callback:function(records,operation,success){console.log(records);var lastState=_.last(records).get("StringValue");console.log("lastState",lastState),me.lastState=lastState,deferred.resolve(lastState)}})}}),deferred.promise},getIterations:function(){var me=this;console.log("Reading iterations for "+me.maxMonths+" months");var deferred=Ext.create("Deft.Deferred"),filter=Ext.create("Rally.data.wsapi.Filter",{property:"StartDate",operator:">=",value:moment().subtract(me.maxMonths,"months").toISOString()});return filter=filter.and(Ext.create("Rally.data.wsapi.Filter",{property:"StartDate",operator:"<=",value:moment().add(me.maxMonths,"months").toISOString()})),me._loadAStoreWithAPromise("Iteration",["Name","EndDate","StartDate"],[filter],{projectScopeDown:!1,projectScopeUp:!1}).then({scope:me,success:function(values){values.push({raw:{StartDate:moment().toISOString(),EndDate:moment().toISOString(),Name:"Today"}}),values=_.sortBy(values,function(value){return moment(value.raw.EndDate)}),console.log(_.map(values,function(v){return v.raw.Name})),me.iterations=values,deferred.resolve(values)},failure:function(error){deferred.resolve([])}}),deferred.promise},getSnapshots:function(iterations){console.log("iterations",iterations);var me=this,promises=_.map(iterations,function(iteration){var deferred=Ext.create("Deft.Deferred"),find={_TypeHierarchy:{$in:["HierarchicalRequirement"]},_ValidFrom:{$lte:iteration.raw.EndDate},_ValidTo:{$gte:iteration.raw.EndDate},Children:null};return me.getContext().getProjectScopeDown()===!0?find._ProjectHierarchy={$in:[me.getContext().getProject().ObjectID]}:find.Project=me.getContext().getProject().ObjectID,me._loadASnapShotStoreWithAPromise(find,["ObjectID","FormattedID","PlanEstimate","ScheduleState"].concat(me.useMVP===!0?me.mvpField:""),["ScheduleState"],null).then({scope:me,success:function(values){deferred.resolve(values)},failure:function(error){console.log("error",error),deferred.resolve([])}}),deferred.promise}),deferred=Ext.create("Deft.Deferred");return Deft.Promise.all(promises).then({scope:me,success:function(all){console.log("all",all),deferred.resolve(all,iterations)}}),deferred.promise},_loadAStoreWithAPromise:function(model_name,model_fields,filters,ctx,order){var deferred=Ext.create("Deft.Deferred"),me=this,config={model:model_name,fetch:model_fields,filters:filters,limit:"Infinity"};return _.isUndefined(ctx)||_.isNull(ctx)||(config.context=ctx),_.isUndefined(order)||_.isNull(order)||(config.order=order),Ext.create("Rally.data.wsapi.Store",config).load({callback:function(records,operation,successful){successful?deferred.resolve(records):deferred.reject("Problem loading: "+operation.error.errors.join(". "))}}),deferred.promise},_loadASnapShotStoreWithAPromise:function(find,fetch,hydrate,ctx){var me=this,deferred=Ext.create("Deft.Deferred"),config={find:find,fetch:fetch,hydrate:hydrate,pageSize:4e3,limit:"Infinity"};_.isUndefined(ctx)||(config.context=ctx);var storeConfig=Ext.merge(config,{removeUnauthorizedSnapshots:!0,autoLoad:!0,listeners:{load:function(store,data,success){deferred.resolve(data)}}});return console.log("storeConfig",storeConfig),Ext.create("Rally.data.lookback.SnapshotStore",storeConfig),deferred.promise},showMask:function(msg){this.getEl()?(this.getEl().unmask(),this.getEl().mask(msg)):console.log("no element")},hideMask:function(){this.getEl().unmask()},config:{defaultSettings:{usemvp:!1,mvpfield:"",mvpvalue:"",maxMonths:1}},getSettingsFields:function(){var me=this;return[{name:"usemvp",xtype:"rallycheckboxfield",fieldLabel:"Show MVP",labelWidth:100,labelAlign:"left",minWidth:200,margin:10},{name:"mvpfield",xtype:"rallytextfield",fieldLabel:"MVP Custom Field Name",labelWidth:100,labelAlign:"left",minWidth:200,margin:10},{name:"mvpvalue",xtype:"rallytextfield",fieldLabel:"MVP Field Value",labelWidth:100,labelAlign:"left",minWidth:200,margin:10},{name:"maxMonths",xtype:"rallytextfield",fieldLabel:"Maximum number of previous months to include iterations from ",labelWidth:100,labelAlign:"left",minWidth:200,margin:10}]}});

            Rally.launchApp('CustomApp', {
                name:"mvp-backlog-burndown",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
